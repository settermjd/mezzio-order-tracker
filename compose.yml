volumes:
  database_data:
    driver: local

secrets:
  db_password:
    environment: DB_PASSWORD

services:
  php:
    build:
      context: ./
      dockerfile: docker/php/Dockerfile
    restart: on-failure:5
    ports:
      - "8080:80"
    volumes:
      - ./:/var/www/html
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/api/ping" ]
      interval: 60s
      timeout: 3s
      retries: 3
    environment:
      DB_HOST: "${DB_HOST}"
      DB_NAME: "${DB_NAME}"
      DB_PASSWORD_FILE: /run/secrets/db_password
      DB_USER: "${DB_USER}"
      LOGGER_LOCATION: "${LOGGER_LOCATION}"
      LOGGER_NAME: "${LOGGER_NAME}"
      SENDGRID_API_KEY: "${SENDGRID_API_KEY}"
      SENDGRID_SENDER_EMAIL: "${SENDGRID_SENDER_EMAIL}"
      SENDGRID_SENDER_NAME: "${SENDGRID_SENDER_NAME}"
      TWILIO_ACCOUNT_SID: "${TWILIO_ACCOUNT_SID}"
      TWILIO_AUTH_TOKEN: "${TWILIO_AUTH_TOKEN}"
      TWILIO_PHONE_NUMBER: "${TWILIO_PHONE_NUMBER}"
    secrets:
      - db_password

  database:
    image: postgres:17.4-alpine3.21
    ports:
      - "54321:5432"
    environment:
      POSTGRES_DB: "${DB_NAME}"
      POSTGRES_USER: "${DB_USER}"
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - database_data:/var/lib/postgresql/data/pgdata
    secrets:
      - db_password
